# RUM Resource Schema ä¸‰ç«¯å¯¹æ¯”åˆ†æ

## æ¦‚è¿°

æœ¬æ–‡æ¡£å¯¹æ¯”äº† Datadog RUM SDK åœ¨ä¸‰ä¸ªå¹³å°ï¼ˆiOSã€Androidã€Webï¼‰ä¸Šçš„ Resource Schema å·®å¼‚ã€‚

ç”Ÿæˆæ—¶é—´ï¼š2025-10-30

---

## ä¸€ã€Schema æ¥æº

### iOS

- **Schema ä½ç½®**ï¼šä» `rum-events-format` ä»“åº“åŠ¨æ€æ‹‰å–
- **Schema æ–‡ä»¶**ï¼š`schemas/rum/resource-schema.json`ï¼ˆåœ¨ `rum-events-mobile-schema.json` ä¸­å¼•ç”¨ï¼‰
- **ç”Ÿæˆæ¨¡å‹ä½ç½®**ï¼š
  - Swift: `DatadogInternal/Sources/Models/RUM/RUMDataModels.swift`
  - Objc: `DatadogRUM/Sources/DataModels/RUMDataModels+objc.swift`
- **ç”Ÿæˆå‘½ä»¤**ï¼š`make rum-models-generate`

### Android

- **Schema ä½ç½®**ï¼šä»“åº“å†…ç›´æ¥ç»´æŠ¤
- **Schema æ–‡ä»¶**ï¼š`features/dd-sdk-android-rum/src/main/json/rum/resource-schema.json`
- **ç”Ÿæˆæ¨¡å‹ä½ç½®**ï¼šé€šè¿‡ä»£ç ç”Ÿæˆå·¥å…·ä» JSON schema ç”Ÿæˆ Kotlin æ•°æ®ç±»

### Web

- **Schema ä½ç½®**ï¼šç‹¬ç«‹çš„ `rum-events-format` ä»“åº“
- **Schema æ–‡ä»¶**ï¼š`rum-events-format/schemas/rum/resource-schema.json`
- **å®ç°æ–¹å¼**ï¼šTypeScript ç±»å‹å®šä¹‰

---

## äºŒã€æ ¸å¿ƒå·®å¼‚å¯¹æ¯”

### 1. é¡¶å±‚å­—æ®µå¯¹æ¯”

#### 1.1 å¿…éœ€å­—æ®µå·®å¼‚

| å¹³å°        | required å­—æ®µ                  |
| ----------- | ------------------------------ |
| **iOS**     | `["type", "view", "resource"]` |
| **Android** | `["type", "view", "resource"]` |
| **Web**     | `["type", "resource"]`         |

**å·®å¼‚è¯´æ˜**ï¼š

- âœ… iOS å’Œ Android è¦æ±‚ `view` å­—æ®µå¿…å¡«
- âŒ Web ä¸å¼ºåˆ¶è¦æ±‚ `view` å­—æ®µ
- **åŸå› **ï¼šç§»åŠ¨ç«¯å¼ºè°ƒ View ä¸Šä¸‹æ–‡ï¼Œæ¯ä¸ªèµ„æºå¿…é¡»å…³è”åˆ°å…·ä½“çš„é¡µé¢è§†å›¾

#### 1.2 é¡¶å±‚ç»“æ„å¯¹æ¯”

| å­—æ®µ           | iOS/Android | Web     | è¯´æ˜                           |
| -------------- | ----------- | ------- | ------------------------------ |
| `type`         | âœ… å¿…éœ€     | âœ… å¿…éœ€ | äº‹ä»¶ç±»å‹ï¼Œå€¼ä¸º "resource"      |
| `date`         | âœ…          | âœ…      | äº‹ä»¶æ—¶é—´æˆ³                     |
| `application`  | âœ…          | âœ…      | åº”ç”¨ä¿¡æ¯                       |
| `service`      | âœ…          | âœ…      | æœåŠ¡åç§°                       |
| `session`      | âœ…          | âœ…      | Session ä¿¡æ¯                   |
| `view`         | âœ… **å¿…éœ€** | âœ… å¯é€‰ | View ä¿¡æ¯ï¼ˆç§»åŠ¨ç«¯å¿…éœ€ï¼‰        |
| `resource`     | âœ… å¿…éœ€     | âœ… å¿…éœ€ | èµ„æºè¯¦æƒ…                       |
| `action`       | âœ…          | âœ…      | å…³è”çš„ç”¨æˆ·æ“ä½œ                 |
| `container`    | âœ…          | âœ…      | **ä¸‰ç«¯éƒ½æ”¯æŒ**ï¼ˆWebView åœºæ™¯ï¼‰ |
| `usr`          | âœ…          | âœ…      | ç”¨æˆ·ä¿¡æ¯                       |
| `context`      | âœ…          | âœ…      | è‡ªå®šä¹‰ä¸Šä¸‹æ–‡                   |
| `_dd`          | âœ…          | âœ…      | å†…éƒ¨å±æ€§ï¼ˆæœ‰å·®å¼‚ï¼Œè§ä¸‹æ–‡ï¼‰     |
| `ddtags`       | âœ…          | âœ…      | æ ‡ç­¾                           |
| `device`       | âœ…          | âœ…      | è®¾å¤‡ä¿¡æ¯                       |
| `os`           | âœ…          | âœ…      | æ“ä½œç³»ç»Ÿä¿¡æ¯                   |
| `connectivity` | âœ…          | âœ…      | ç½‘ç»œè¿æ¥ä¿¡æ¯                   |

**é‡è¦è¯´æ˜**ï¼š

âœ… **container å­—æ®µä¸‰ç«¯éƒ½æ”¯æŒï¼**

- å®ƒé€šè¿‡ `_view-container-schema.json` è¢«å¼•å…¥
- ç”¨äº WebView ç­‰åµŒå¥—è§†å›¾åœºæ™¯
- å½“ `source: "browser"` ä¸”å­˜åœ¨åŸç”Ÿçˆ¶å®¹å™¨æ—¶ï¼Œæ‰ä¼šå¡«å……æ­¤å­—æ®µ

---

### 2. `resource` å¯¹è±¡å­—æ®µæ·±åº¦å¯¹æ¯”

#### 2.1 åŸºç¡€å±æ€§å¯¹æ¯”

| å­—æ®µ          | iOS/Android | Web     | ç±»å‹    | è¯´æ˜                     |
| ------------- | ----------- | ------- | ------- | ------------------------ |
| `id`          | âœ…          | âœ…      | string  | UUID æ ¼å¼çš„èµ„æº ID       |
| `type`        | âœ… å¿…éœ€     | âœ… å¿…éœ€ | enum    | èµ„æºç±»å‹ï¼ˆè§æšä¸¾å€¼å¯¹æ¯”ï¼‰ |
| `method`      | âœ…          | âœ…      | enum    | HTTP æ–¹æ³•                |
| `url`         | âœ… å¿…éœ€     | âœ… å¿…éœ€ | string  | èµ„æº URL                 |
| `status_code` | âœ…          | âœ…      | integer | HTTP çŠ¶æ€ç               |
| `duration`    | âœ…          | âœ…      | integer | èµ„æºåŠ è½½æ—¶é•¿ï¼ˆçº³ç§’ï¼‰     |

**æšä¸¾å€¼å¯¹æ¯”**ï¼š

```javascript
// resource.type - ä¸‰ç«¯å®Œå…¨ä¸€è‡´
[
  "document",
  "xhr",
  "beacon",
  "fetch",
  "css",
  "js",
  "image",
  "font",
  "media",
  "other",
  "native",
][
  // resource.method - ä¸‰ç«¯å®Œå…¨ä¸€è‡´
  ("POST",
  "GET",
  "HEAD",
  "PUT",
  "DELETE",
  "PATCH",
  "TRACE",
  "OPTIONS",
  "CONNECT")
];
```

#### 2.2 å¤§å°ç›¸å…³å±æ€§å¯¹æ¯”

| å­—æ®µ                | iOS/Android | Web | ç±»å‹    | è¯´æ˜               |
| ------------------- | ----------- | --- | ------- | ------------------ |
| `size`              | âœ…          | âœ…  | integer | å“åº”ä½“å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| `encoded_body_size` | âœ…          | âœ…  | integer | ç¼–ç å‰å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| `decoded_body_size` | âœ…          | âœ…  | integer | è§£ç åå¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| `transfer_size`     | âœ…          | âœ…  | integer | ä¼ è¾“å¤§å°ï¼ˆå­—èŠ‚ï¼‰   |

**è¯´æ˜**ï¼šä¸‰ç«¯åœ¨å¤§å°ç›¸å…³å­—æ®µä¸Š**å®Œå…¨ä¸€è‡´**ã€‚

#### 2.3 ç½‘ç»œé˜¶æ®µå±æ€§å¯¹æ¯”ï¼ˆæ‰€æœ‰ç½‘ç»œé˜¶æ®µç»“æ„ç›¸åŒï¼‰

æ‰€æœ‰ç½‘ç»œé˜¶æ®µå¯¹è±¡éƒ½åŒ…å«ç›¸åŒçš„å­å­—æ®µï¼š

| é˜¶æ®µå¯¹è±¡     | iOS/Android | Web | å­å­—æ®µ                            |
| ------------ | ----------- | --- | --------------------------------- |
| `worker`     | âœ…          | âœ…  | `duration`, `start`ï¼ˆå•ä½ï¼šçº³ç§’ï¼‰ |
| `redirect`   | âœ…          | âœ…  | `duration`, `start`ï¼ˆå•ä½ï¼šçº³ç§’ï¼‰ |
| `dns`        | âœ…          | âœ…  | `duration`, `start`ï¼ˆå•ä½ï¼šçº³ç§’ï¼‰ |
| `connect`    | âœ…          | âœ…  | `duration`, `start`ï¼ˆå•ä½ï¼šçº³ç§’ï¼‰ |
| `ssl`        | âœ…          | âœ…  | `duration`, `start`ï¼ˆå•ä½ï¼šçº³ç§’ï¼‰ |
| `first_byte` | âœ…          | âœ…  | `duration`, `start`ï¼ˆå•ä½ï¼šçº³ç§’ï¼‰ |
| `download`   | âœ…          | âœ…  | `duration`, `start`ï¼ˆå•ä½ï¼šçº³ç§’ï¼‰ |

**æ¯ä¸ªé˜¶æ®µå¯¹è±¡çš„ç»“æ„**ï¼š

```json
{
  "duration": 1000000, // è¯¥é˜¶æ®µæŒç»­æ—¶é•¿ï¼ˆçº³ç§’ï¼‰
  "start": 500000 // ä»è¯·æ±‚å¼€å§‹åˆ°è¯¥é˜¶æ®µå¼€å§‹çš„æ—¶é•¿ï¼ˆçº³ç§’ï¼‰
}
```

**è¯´æ˜**ï¼šä¸‰ç«¯åœ¨æ‰€æœ‰ç½‘ç»œé˜¶æ®µå­—æ®µä¸Š**å®Œå…¨ä¸€è‡´**ï¼Œæ‰€æœ‰æ—¶é—´å•ä½éƒ½æ˜¯çº³ç§’ï¼ˆnsï¼‰ã€‚

#### 2.4 å…¶ä»–å±æ€§å¯¹æ¯”

| å­—æ®µ                     | iOS/Android | Web | ç±»å‹   | è¯´æ˜                            |
| ------------------------ | ----------- | --- | ------ | ------------------------------- |
| `protocol`               | âœ…          | âœ…  | string | ç½‘ç»œåè®®ï¼ˆå¦‚ 'http/1.1', 'h2'ï¼‰ |
| `delivery_type`          | âœ…          | âœ…  | enum   | äº¤ä»˜ç±»å‹ï¼ˆè§ä¸‹æ–‡ï¼‰              |
| `render_blocking_status` | âœ…          | âœ…  | enum   | æ¸²æŸ“é˜»å¡çŠ¶æ€ï¼ˆè§ä¸‹æ–‡ï¼‰          |
| `provider`               | âœ…          | âœ…  | object | èµ„æºæä¾›å•†ä¿¡æ¯ï¼ˆè§ä¸‹æ–‡ï¼‰        |
| `graphql`                | âœ…          | âœ…  | object | GraphQL ä¿¡æ¯ï¼ˆ**æœ‰å·®å¼‚**ï¼‰      |

**æšä¸¾å€¼å¯¹æ¯”**ï¼š

```javascript
// delivery_type - ä¸‰ç«¯å®Œå…¨ä¸€è‡´
["cache", "navigational-prefetch", "other"][
  // render_blocking_status - ä¸‰ç«¯å®Œå…¨ä¸€è‡´
  ("blocking", "non-blocking")
];
```

---

### 3. `resource.provider` å¯¹è±¡å­—æ®µå¯¹æ¯”

| å­—æ®µ     | iOS/Android | Web | ç±»å‹   | è¯´æ˜           |
| -------- | ----------- | --- | ------ | -------------- |
| `domain` | âœ…          | âœ…  | string | æä¾›å•†åŸŸå     |
| `name`   | âœ…          | âœ…  | string | æä¾›å•†å‹å¥½åç§° |
| `type`   | âœ…          | âœ…  | enum   | æä¾›å•†ç±»å‹     |

**provider.type æšä¸¾å€¼**ï¼ˆä¸‰ç«¯å®Œå…¨ä¸€è‡´ï¼‰ï¼š

```javascript
[
  "ad",
  "advertising",
  "analytics",
  "cdn",
  "content",
  "customer-success",
  "first party",
  "hosting",
  "marketing",
  "other",
  "social",
  "tag-manager",
  "utility",
  "video",
];
```

**è¯´æ˜**ï¼š`provider` å¯¹è±¡åœ¨ä¸‰ç«¯ä¸Š**å®Œå…¨ä¸€è‡´**ã€‚

---

### 4. `resource.graphql` å¯¹è±¡å­—æ®µå¯¹æ¯”ï¼ˆâš ï¸ æœ‰é‡è¦å·®å¼‚ï¼‰

#### 4.1 åŸºç¡€å­—æ®µå¯¹æ¯”

| å­—æ®µ            | iOS/Android | Web     | ç±»å‹    | è¯´æ˜                   |
| --------------- | ----------- | ------- | ------- | ---------------------- |
| `operationType` | âœ… å¿…éœ€     | âœ… å¿…éœ€ | enum    | æ“ä½œç±»å‹               |
| `operationName` | âœ…          | âœ…      | string  | æ“ä½œåç§°               |
| `payload`       | âœ…          | âœ…      | string  | æ“ä½œå†…å®¹               |
| `variables`     | âœ…          | âœ…      | string  | æ“ä½œå˜é‡ï¼ˆå­—ç¬¦ä¸²è¡¨ç¤ºï¼‰ |
| `error_count`   | âœ…          | âŒ      | integer | **iOS/Android ç‹¬æœ‰**   |
| `errors`        | âœ…          | âŒ      | array   | **iOS/Android ç‹¬æœ‰**   |

**operationType æšä¸¾å€¼**ï¼ˆä¸‰ç«¯å®Œå…¨ä¸€è‡´ï¼‰ï¼š

```javascript
["query", "mutation", "subscription"];
```

#### 4.2 GraphQL errors æ•°ç»„ç»“æ„ï¼ˆä»… iOS/Androidï¼‰

ç§»åŠ¨ç«¯æ”¯æŒè¯¦ç»†çš„ GraphQL é”™è¯¯è¿½è¸ªï¼š

```json
{
  "graphql": {
    "operationType": "query",
    "operationName": "GetUser",
    "error_count": 2, // â† Web ç«¯æ²¡æœ‰
    "errors": [
      // â† Web ç«¯æ²¡æœ‰
      {
        "message": "Field 'email' not found", // å¿…éœ€
        "code": "FIELD_NOT_FOUND", // å¯é€‰
        "locations": [
          // å¯é€‰
          {
            "line": 3,
            "column": 5
          }
        ],
        "path": ["user", "email"] // å¯é€‰
      }
    ]
  }
}
```

**errors æ•°ç»„ä¸­æ¯ä¸ªé”™è¯¯å¯¹è±¡çš„å­—æ®µ**ï¼š

| å­—æ®µ        | å¿…éœ€ | ç±»å‹   | è¯´æ˜                     |
| ----------- | ---- | ------ | ------------------------ |
| `message`   | âœ…   | string | é”™è¯¯æ¶ˆæ¯                 |
| `code`      | âŒ   | string | é”™è¯¯ä»£ç                  |
| `locations` | âŒ   | array  | é”™è¯¯ä½ç½®ï¼ˆline, columnï¼‰ |
| `path`      | âŒ   | array  | å¯¼è‡´é”™è¯¯çš„å­—æ®µè·¯å¾„       |

**å·®å¼‚æ€»ç»“**ï¼š

- âœ… **iOS/Android**ï¼šå®Œæ•´çš„ GraphQL é”™è¯¯è¿½è¸ªèƒ½åŠ›ï¼ŒåŒ…æ‹¬é”™è¯¯è®¡æ•°ã€é”™è¯¯è¯¦æƒ…ã€ä½ç½®å’Œè·¯å¾„
- âŒ **Web**ï¼šä»…æ”¯æŒåŸºç¡€çš„ GraphQL ä¿¡æ¯ï¼ˆoperationType, operationName, payload, variablesï¼‰

---

### 5. `_dd` å†…éƒ¨å±æ€§æ·±åº¦å¯¹æ¯”

#### 5.1 å­—æ®µå¯¹æ¯”è¡¨

| å­—æ®µ                  | iOS/Android | Web | ç±»å‹    | è¯´æ˜                              |
| --------------------- | ----------- | --- | ------- | --------------------------------- |
| `format_version`      | âœ…          | âœ…  | integer | RUM äº‹ä»¶æ ¼å¼ç‰ˆæœ¬ï¼ˆå›ºå®šä¸º 2ï¼‰      |
| `span_id`             | âœ…          | âœ…  | string  | Span IDï¼ˆåè¿›åˆ¶æ ¼å¼ï¼‰             |
| `parent_span_id`      | âœ…          | âŒ  | string  | **iOS/Android ç‹¬æœ‰** - çˆ¶ Span ID |
| `trace_id`            | âœ…          | âœ…  | string  | Trace IDï¼ˆ**æ ¼å¼æœ‰å·®å¼‚**ï¼‰        |
| `rule_psr`            | âœ…          | âœ…  | number  | é‡‡æ ·ç‡ï¼ˆ0-1ï¼‰                     |
| `discarded`           | âœ…          | âœ…  | boolean | æ˜¯å¦ä¸¢å¼ƒè¯¥èµ„æº                    |
| `session`             | âœ…          | âœ…  | object  | Session ç›¸å…³å†…éƒ¨å±æ€§              |
| `configuration`       | âœ…          | âœ…  | object  | SDK é…ç½®é€‰é¡¹å­é›†                  |
| `browser_sdk_version` | âŒ          | âœ…  | string  | **Web ç‹¬æœ‰** - Browser SDK ç‰ˆæœ¬   |
| `sdk_name`            | âœ…          | âœ…  | string  | SDK åç§°ï¼ˆå¦‚ 'rum', 'rum-slim'ï¼‰  |
| `drift`               | âŒ          | âœ…  | number  | **Web ç‹¬æœ‰** - æ—¶é—´æ¼‚ç§»           |

#### 5.2 æ ¸å¿ƒå·®å¼‚è¯¦è§£

**å·®å¼‚ 1ï¼šparent_span_id**

```json
// iOS/Android - æ”¯æŒçˆ¶ Span ID
{
  "_dd": {
    "span_id": "123456",
    "parent_span_id": "789012",  // â† æ”¯æŒ
    "trace_id": "..."
  }
}

// Web - ä¸æ”¯æŒ
{
  "_dd": {
    "span_id": "123456",
    // æ²¡æœ‰ parent_span_id
    "trace_id": "..."
  }
}
```

**å·®å¼‚ 2ï¼štrace_id æ ¼å¼**

```json
// iOS/Android - çµæ´»æ ¼å¼
{
  "trace_id": "12345678901234567890"  // 64ä½åè¿›åˆ¶
  // OR
  "trace_id": "0123456789abcdef0123456789abcdef"  // 128ä½åå…­è¿›åˆ¶
  // Pattern: ^[0-9]{1,20}|[0-9a-fA-F]{32}$
}

// Web - ä»…åè¿›åˆ¶
{
  "trace_id": "12345678901234567890"  // ä»…åè¿›åˆ¶
  // Pattern: ^[0-9]+$
}
```

#### 5.3 `_dd.session` å­å¯¹è±¡å¯¹æ¯”

| å­—æ®µ                   | iOS/Android | Web | è¯´æ˜                                     |
| ---------------------- | ----------- | --- | ---------------------------------------- |
| `plan`                 | âœ…          | âœ…  | Session è®¡åˆ’ï¼ˆ1=æ—  replay, 2=æœ‰ replayï¼‰ |
| `session_precondition` | âœ…          | âœ…  | Session åˆ›å»ºå‰ææ¡ä»¶                     |

**session_precondition æšä¸¾å€¼**ï¼ˆä¸‰ç«¯ä¸€è‡´ï¼‰ï¼š

```javascript
[
  "user_app_launch",
  "inactivity_timeout",
  "max_duration",
  "background_launch",
  "prewarm",
  "from_non_interactive_session",
  "explicit_stop",
];
```

#### 5.4 `_dd.configuration` å­å¯¹è±¡å¯¹æ¯”

| å­—æ®µ                         | iOS/Android | Web | è¯´æ˜                   |
| ---------------------------- | ----------- | --- | ---------------------- |
| `session_sample_rate`        | âœ…          | âœ…  | Session é‡‡æ ·ç‡ï¼ˆå¿…éœ€ï¼‰ |
| `session_replay_sample_rate` | âœ…          | âœ…  | Session Replay é‡‡æ ·ç‡  |
| `profiling_sample_rate`      | âœ…          | âŒ  | **iOS/Android ç‹¬æœ‰**   |

---

### 6. `container` å¯¹è±¡å­—æ®µæ·±åº¦å¯¹æ¯”

**âœ… ä¸‰ç«¯å®Œå…¨ä¸€è‡´ï¼**

| å­—æ®µ      | iOS/Android | Web     | ç±»å‹   | è¯´æ˜           |
| --------- | ----------- | ------- | ------ | -------------- |
| `view.id` | âœ… å¿…éœ€     | âœ… å¿…éœ€ | string | çˆ¶è§†å›¾ UUID    |
| `source`  | âœ… å¿…éœ€     | âœ… å¿…éœ€ | enum   | çˆ¶è§†å›¾å¹³å°æ¥æº |

**container.source æšä¸¾å€¼**ï¼ˆä¸‰ç«¯å®Œå…¨ä¸€è‡´ï¼‰ï¼š

```javascript
[
  "android",
  "ios",
  "browser",
  "flutter",
  "react-native",
  "roku",
  "unity",
  "kotlin-multiplatform",
];
```

**å®Œæ•´ç»“æ„ç¤ºä¾‹**ï¼š

```json
{
  "container": {
    "view": {
      "id": "abc-123-def-456" // çˆ¶è§†å›¾ UUIDï¼ˆå¿…éœ€ï¼‰
    },
    "source": "android" // çˆ¶è§†å›¾æ¥æºï¼ˆå¿…éœ€ï¼‰
  }
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š

- âœ… çº¯åŸç”Ÿåº”ç”¨ï¼š**æ— ** container å­—æ®µ
- âœ… çº¯ Web åº”ç”¨ï¼š**æ— ** container å­—æ®µ
- âœ… WebViewï¼ˆç§»åŠ¨å†…ï¼‰ï¼š**æœ‰** container å­—æ®µï¼Œ`source: "browser"`, `container.source: "android"/"ios"`
- âœ… Flutter/React Native WebViewï¼š**æœ‰** container å­—æ®µ

---

## ä¸‰ã€å¯¹æ¯”å±‚çº§æ€»ç»“

### æœ¬æ–‡æ¡£å¯¹æ¯”äº† **4 ä¸ªå±‚çº§**ï¼š

#### **å±‚çº§ 1ï¼šé¡¶å±‚å­—æ®µ**

- âœ… type, date, application, service, session
- âœ… view, resource, action, container
- âœ… usr, context, \_dd, ddtags, device, os, connectivity

#### **å±‚çº§ 2ï¼šresource å¯¹è±¡åŠå…¶å­å¯¹è±¡**

- âœ… resource åŸºç¡€å±æ€§ï¼ˆid, type, method, url, status_code, durationï¼‰
- âœ… resource å¤§å°å±æ€§ï¼ˆsize, encoded_body_size, decoded_body_size, transfer_sizeï¼‰
- âœ… resource ç½‘ç»œé˜¶æ®µï¼ˆworker, redirect, dns, connect, ssl, first_byte, downloadï¼‰
- âœ… resource å…¶ä»–å±æ€§ï¼ˆprotocol, delivery_type, render_blocking_statusï¼‰
- âœ… resource.provider å­å¯¹è±¡ï¼ˆdomain, name, typeï¼‰
- âœ… resource.graphql å­å¯¹è±¡ï¼ˆoperationType, operationName, payload, variables, error_count, errorsï¼‰

#### **å±‚çº§ 3ï¼š\_dd å¯¹è±¡åŠå…¶å­å¯¹è±¡**

- âœ… \_dd åŸºç¡€å±æ€§ï¼ˆformat_version, span_id, parent_span_id, trace_id, rule_psr, discardedï¼‰
- âœ… \_dd.session å­å¯¹è±¡ï¼ˆplan, session_preconditionï¼‰
- âœ… \_dd.configuration å­å¯¹è±¡ï¼ˆsession_sample_rate, session_replay_sample_rate, profiling_sample_rateï¼‰

#### **å±‚çº§ 4ï¼šcontainer å¯¹è±¡**

- âœ… container.view å­å¯¹è±¡ï¼ˆidï¼‰
- âœ… container.source

### å…³é”®å‘ç°æ€»ç»“

| å¯¹æ¯”é¡¹                  | ç»“è®º                                         | å½±å“ |
| ----------------------- | -------------------------------------------- | ---- |
| **é¡¶å±‚ç»“æ„**            | å‡ ä¹å®Œå…¨ä¸€è‡´ï¼Œä»… `view` å¿…éœ€æ€§ä¸åŒ           | ä½   |
| **resource åŸºç¡€å­—æ®µ**   | **å®Œå…¨ä¸€è‡´**                                 | æ—    |
| **ç½‘ç»œé˜¶æ®µå­—æ®µ**        | **å®Œå…¨ä¸€è‡´**ï¼ˆ7 ä¸ªé˜¶æ®µï¼Œæ‰€æœ‰æ—¶é—´å•ä½ï¼šçº³ç§’ï¼‰ | æ—    |
| **provider å¯¹è±¡**       | **å®Œå…¨ä¸€è‡´**                                 | æ—    |
| **graphql å¯¹è±¡**        | **é‡è¦å·®å¼‚** - ç§»åŠ¨ç«¯æ”¯æŒé”™è¯¯è¿½è¸ª            | ä¸­   |
| **\_dd.parent_span_id** | **é‡è¦å·®å¼‚** - Web ä¸æ”¯æŒ                    | ä¸­   |
| **\_dd.trace_id æ ¼å¼**  | **é‡è¦å·®å¼‚** - ç§»åŠ¨ç«¯æ”¯æŒå¤šç§æ ¼å¼            | ä¸­   |
| **container å¯¹è±¡**      | **å®Œå…¨ä¸€è‡´**ï¼ˆä¸‰ç«¯éƒ½æ”¯æŒï¼‰                   | æ—    |

---

## å››ã€ç›¸åŒç‚¹æ±‡æ€»

ä»¥ä¸‹å±æ€§åœ¨ä¸‰ä¸ªå¹³å°ä¸Š**å®Œå…¨ä¸€è‡´**ï¼š

### Resource åŸºç¡€å±æ€§

- âœ… `id`ï¼šUUID æ ¼å¼
- âœ… `type`ï¼šèµ„æºç±»å‹æšä¸¾ï¼ˆdocument, xhr, beacon, fetch, css, js, image, font, media, other, nativeï¼‰
- âœ… `method`ï¼šHTTP æ–¹æ³•æšä¸¾
- âœ… `url`ï¼šèµ„æº URL
- âœ… `status_code`ï¼šHTTP çŠ¶æ€ç 
- âœ… `duration`ï¼šèµ„æºåŠ è½½æ—¶é•¿

### æ€§èƒ½æŒ‡æ ‡å±æ€§

- âœ… `size`ï¼šå“åº”ä½“å¤§å°
- âœ… `encoded_body_size`ï¼šç¼–ç å‰å¤§å°
- âœ… `decoded_body_size`ï¼šè§£ç åå¤§å°
- âœ… `transfer_size`ï¼šä¼ è¾“å¤§å°
- âœ… `render_blocking_status`ï¼šæ¸²æŸ“é˜»å¡çŠ¶æ€

### ç½‘ç»œé˜¶æ®µå±æ€§ï¼ˆ7 ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªåŒ…å« duration å’Œ startï¼‰

- âœ… `worker`ï¼šWorker é˜¶æ®µ
- âœ… `redirect`ï¼šé‡å®šå‘é˜¶æ®µ
- âœ… `dns`ï¼šDNS è§£æé˜¶æ®µ
- âœ… `connect`ï¼šè¿æ¥é˜¶æ®µ
- âœ… `ssl`ï¼šSSL æ¡æ‰‹é˜¶æ®µ
- âœ… `first_byte`ï¼šé¦–å­—èŠ‚é˜¶æ®µ
- âœ… `download`ï¼šä¸‹è½½é˜¶æ®µ

### å…¶ä»–å±æ€§

- âœ… `protocol`ï¼šç½‘ç»œåè®®ï¼ˆå¦‚ 'http/1.1', 'h2'ï¼‰
- âœ… `delivery_type`ï¼šäº¤ä»˜ç±»å‹ï¼ˆcache, navigational-prefetch, otherï¼‰
- âœ… `provider`ï¼šèµ„æºæä¾›å•†ä¿¡æ¯ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰
- âœ… `container`ï¼šçˆ¶è§†å›¾å®¹å™¨ä¿¡æ¯ï¼ˆ**ä¸‰ç«¯éƒ½æ”¯æŒ**ï¼Œå®Œå…¨ä¸€è‡´ï¼‰

---

---

## äº”ã€ä¸ºä»€ä¹ˆç§»åŠ¨ç«¯éœ€è¦ parent_span_idï¼Ÿï¼ˆé‡è¦æ¶æ„å·®å¼‚ï¼‰

### é—®é¢˜èƒŒæ™¯

| å¹³å°        | parent_span_id æ”¯æŒ | è¯´æ˜                          |
| ----------- | ------------------- | ----------------------------- |
| iOS/Android | âœ… **æ”¯æŒ**         | å¯è¿½è¸ªå®Œæ•´çš„ span å±‚æ¬¡ç»“æ„    |
| Web         | âŒ **ä¸æ”¯æŒ**       | RUM Resource äº‹ä»¶ä¸­æ²¡æœ‰æ­¤å­—æ®µ |

### æ ¸å¿ƒåŸå› ï¼šç§»åŠ¨ç«¯çš„ APM Tracing æ¶æ„æ›´å¤æ‚

#### 1. ç§»åŠ¨ç«¯æ”¯æŒå®Œæ•´çš„ APM Tracing SDK

**ç§»åŠ¨ç«¯æ¶æ„**ï¼š

```
ç§»åŠ¨åº”ç”¨
â”œâ”€â”€ RUM SDK (å®æ—¶ç”¨æˆ·ç›‘æ§)
â”‚   â””â”€â”€ è‡ªåŠ¨é‡‡é›†èµ„æºã€è§†å›¾ã€æ“ä½œã€é”™è¯¯
â”œâ”€â”€ APM Tracing SDK (åº”ç”¨æ€§èƒ½è¿½è¸ª)
â”‚   â”œâ”€â”€ è‡ªåŠ¨è¿½è¸ªç½‘ç»œè¯·æ±‚ï¼ˆç”Ÿæˆ Spanï¼‰
â”‚   â”œâ”€â”€ è‡ªå®šä¹‰ Spanï¼ˆä¸šåŠ¡é€»è¾‘è¿½è¸ªï¼‰
â”‚   â””â”€â”€ æ”¯æŒå®Œæ•´çš„ Span å±‚æ¬¡ç»“æ„
â””â”€â”€ é›†æˆå±‚ï¼šRUM â‡„ APM
    â””â”€â”€ RUM Resource äº‹ä»¶éœ€è¦å…³è” APM Span
```

**Web ç«¯æ¶æ„**ï¼š

```
Web åº”ç”¨
â”œâ”€â”€ RUM SDK (å®æ—¶ç”¨æˆ·ç›‘æ§)
â”‚   â””â”€â”€ è‡ªåŠ¨é‡‡é›†èµ„æºã€è§†å›¾ã€æ“ä½œã€é”™è¯¯
â””â”€â”€ Tracingï¼ˆç®€åŒ–ç‰ˆï¼‰
    â”œâ”€â”€ ä»…æ”¯æŒåŸºç¡€çš„ span_id å’Œ trace_id
    â””â”€â”€ æ²¡æœ‰å¤æ‚çš„ Span å±‚æ¬¡ç»“æ„
```

#### 2. å…¸å‹åœºæ™¯å¯¹æ¯”

**åœºæ™¯ï¼šç”¨æˆ·ç‚¹å‡»æŒ‰é’® â†’ è°ƒç”¨ API â†’ å‘èµ· HTTP è¯·æ±‚**

**ç§»åŠ¨ç«¯çš„ Span å±‚æ¬¡ç»“æ„**ï¼š

```
Root Span: ç”¨æˆ·æ“ä½œ (span_id: 1000)
  â”‚
  â”œâ”€ Child Span: API è°ƒç”¨é€»è¾‘ (span_id: 2000, parent_span_id: 1000)
  â”‚    â”‚
  â”‚    â””â”€ Child Span: HTTP è¯·æ±‚ (span_id: 3000, parent_span_id: 2000)
  â”‚         â””â”€ RUM Resource Event â† éœ€è¦è®°å½•å®Œæ•´é“¾è·¯ï¼
  â”‚              - span_id: 3000
  â”‚              - parent_span_id: 2000  â† å…³é”®ï¼
  â”‚              - trace_id: abc123
```

**Web ç«¯çš„ç®€åŒ–ç»“æ„**ï¼š

```
RUM Resource Eventï¼ˆç”±æµè§ˆå™¨è‡ªåŠ¨é‡‡é›†ï¼‰
  - span_id: 3000
  - trace_id: abc123
  - âŒ æ²¡æœ‰ parent_span_idï¼ˆä¸éœ€è¦å¤æ‚å±‚æ¬¡ï¼‰
```

#### 3. parent_span_id çš„å…³é”®ä½œç”¨

##### ä½œç”¨ 1ï¼šæ„å»ºå®Œæ•´çš„è°ƒç”¨é“¾ç«ç„°å›¾

**æœ‰ parent_span_idï¼ˆç§»åŠ¨ç«¯ï¼‰**ï¼š

```
APM Flame Graphï¼ˆç«ç„°å›¾ï¼‰ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  Root Span: onClick()                    [1000ms]
  â”œâ”€ getUserProfile()                     [800ms]
  â”‚  â”œâ”€ validateToken()                   [50ms]
  â”‚  â”œâ”€ HTTP GET /api/user                [700ms] â† RUM Resource
  â”‚  â”‚  â”œâ”€ DNS Lookup                     [10ms]
  â”‚  â”‚  â”œâ”€ TCP Connect                    [20ms]
  â”‚  â”‚  â”œâ”€ SSL Handshake                  [30ms]
  â”‚  â”‚  â””â”€ Download                       [640ms]
  â”‚  â””â”€ parseResponse()                   [50ms]
  â””â”€ updateUI()                           [200ms]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**æ²¡æœ‰ parent_span_idï¼ˆWeb ç«¯ï¼‰**ï¼š

```
åªèƒ½çœ‹åˆ°æ‰å¹³çš„èµ„æºåˆ—è¡¨ï¼Œæ— æ³•æ„å»ºè°ƒç”¨å±‚æ¬¡ï¼š
- Resource: GET /api/user [700ms]
- Resource: GET /api/posts [500ms]
- Resource: GET /styles.css [100ms]
```

##### ä½œç”¨ 2ï¼šè·¨æœåŠ¡åˆ†å¸ƒå¼è¿½è¸ª

**ç§»åŠ¨ç«¯åœºæ™¯**ï¼š

```
æ‰‹æœº App (iOS/Android)
  â””â”€ Span: ç”¨æˆ·æ“ä½œ (span_id: 1000)
      â””â”€ Span: HTTP è¯·æ±‚ (span_id: 2000, parent_span_id: 1000)
          â”‚
          â”œâ”€ HTTP Headers ä¼ é€’:
          â”‚    X-Datadog-Trace-Id: abc123
          â”‚    X-Datadog-Parent-Id: 2000  â† ä¼ é€’å½“å‰ span_id
          â”‚
          â””â”€ å‘é€åˆ°åç«¯ â†’
                          â†“
              åç«¯æœåŠ¡å™¨ (Node.js/Java)
                â””â”€ Span: handleRequest (span_id: 3000, parent_span_id: 2000)
                    â”œâ”€ Span: queryDatabase (span_id: 4000, parent_span_id: 3000)
                    â””â”€ Span: callMicroservice (span_id: 5000, parent_span_id: 3000)

å®Œæ•´çš„åˆ†å¸ƒå¼è¿½è¸ªé“¾ï¼š
1000 â†’ 2000 â†’ 3000 â†’ 4000
              â””â”€â”€â”€â†’ 5000
```

##### ä½œç”¨ 3ï¼šå…³è” RUM å’Œ APM æ•°æ®

**æ•°æ®æµå‘**ï¼š

```
ç§»åŠ¨ç«¯ SDK
  â”œâ”€ APM Tracing SDK
  â”‚   â””â”€ ç”Ÿæˆ Span (span_id: 2000, parent_span_id: 1000)
  â”‚
  â””â”€ RUM SDK
      â””â”€ ç”Ÿæˆ RUM Resource Event
          â”œâ”€ ä» APM Span Context æå–ï¼š
          â”‚   - span_id: 2000
          â”‚   - parent_span_id: 1000  â† ä¿æŒä¸€è‡´æ€§ï¼
          â”‚   - trace_id: abc123
          â”‚   - rule_psr: 0.5
          â”‚
          â””â”€ ä¸ŠæŠ¥åˆ° Datadog åç«¯
              â””â”€ åç«¯å¯ä»¥ï¼š
                  âœ… å°† RUM Resource å…³è”åˆ° APM Span
                  âœ… åœ¨ APM ç«ç„°å›¾ä¸­æ˜¾ç¤º RUM èµ„æº
                  âœ… åœ¨ RUM ä¸­è·³è½¬åˆ°å¯¹åº”çš„ APM Trace
```

#### 4. å®é™…ä»£ç ç¤ºä¾‹

**ç§»åŠ¨ç«¯ï¼ˆAndroidï¼‰**ï¼š

```kotlin
// APM è‡ªå®šä¹‰ Span
val parentSpan = tracer.buildSpan("getUserProfile").start()

// å‘èµ· HTTP è¯·æ±‚ï¼ˆè‡ªåŠ¨åˆ›å»ºå­ Spanï¼‰
val request = Request.Builder()
    .url("https://api.example.com/user")
    .build()

// RUM SDK è‡ªåŠ¨é‡‡é›† Resourceï¼Œå¹¶æå– Span Context
// Resource Event å°†åŒ…å«ï¼š
// - span_id: <HTTP è¯·æ±‚çš„ Span ID>
// - parent_span_id: <parentSpan çš„ Span ID>  â† å…³é”®ï¼
// - trace_id: <Trace ID>

client.newCall(request).execute()
parentSpan.finish()
```

**Web ç«¯**ï¼š

```javascript
// Web ç«¯æ²¡æœ‰æ˜¾å¼çš„ Span ç®¡ç†
// æµè§ˆå™¨è‡ªåŠ¨é‡‡é›†èµ„æº
fetch("https://api.example.com/user");

// RUM Resource Event è‡ªåŠ¨ç”Ÿæˆï¼Œä½†åªåŒ…å«ï¼š
// - span_id: <è‡ªåŠ¨ç”Ÿæˆ>
// - trace_id: <è‡ªåŠ¨ç”Ÿæˆ>
// âŒ æ²¡æœ‰ parent_span_idï¼ˆä¸éœ€è¦å±‚æ¬¡ç»“æ„ï¼‰
```

#### 5. ä¸ºä»€ä¹ˆ Web ç«¯ä¸éœ€è¦ï¼Ÿ

| åŸå›                | ç§»åŠ¨ç«¯                       | Web ç«¯                      |
| ------------------ | ---------------------------- | --------------------------- |
| **è¿½è¸ªç²’åº¦**       | éœ€è¦è¿½è¸ªåº”ç”¨å†…çš„ä¸šåŠ¡é€»è¾‘     | ä¸»è¦è¿½è¸ªç½‘ç»œèµ„æºåŠ è½½        |
| **Span å±‚æ¬¡**      | æ”¯æŒå¤šå±‚åµŒå¥— Span            | æ‰å¹³ç»“æ„ï¼Œä¸€ä¸ªèµ„æºä¸€ä¸ª Span |
| **APM é›†æˆ**       | æ·±åº¦é›†æˆ APM Tracing SDK     | è½»é‡çº§é›†æˆï¼Œæ— å®Œæ•´ APM      |
| **åˆ†å¸ƒå¼è¿½è¸ª**     | éœ€è¦å®Œæ•´çš„ parent-child å…³ç³» | ä¸»è¦å…³æ³¨ç«¯åˆ°ç«¯å»¶è¿Ÿ          |
| **å¼€å‘è€…ä½¿ç”¨åœºæ™¯** | è‡ªå®šä¹‰ Span è¿½è¸ªä¸šåŠ¡æµç¨‹     | ä¸»è¦ä¾èµ–æµè§ˆå™¨è‡ªåŠ¨è¿½è¸ª      |
| **æ€§èƒ½åˆ†æ**       | éœ€è¦è¯¦ç»†çš„è°ƒç”¨æ ˆç«ç„°å›¾       | ä¸»è¦çœ‹èµ„æºåŠ è½½ç€‘å¸ƒå›¾        |

#### 6. å¯è§†åŒ–å¯¹æ¯”

**ç§»åŠ¨ç«¯ï¼ˆæœ‰ parent_span_idï¼‰çš„æ•°æ®å…³è”**ï¼š

```
Datadog åå°è§†å›¾ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RUM Explorer (ç”¨æˆ·ä¼šè¯è§†å›¾)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Session: abc-123                                           â”‚
â”‚  â””â”€ View: ProductListView                                   â”‚
â”‚      â””â”€ Action: ç‚¹å‡»å•†å“æŒ‰é’®                                â”‚
â”‚          â””â”€ Resource: GET /api/product/123 [700ms] â† ç‚¹å‡»å¯è·³è½¬
â”‚                â†“                                             â”‚
â”‚              [è·³è½¬åˆ° APM]                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APM Trace View (åˆ†å¸ƒå¼è¿½è¸ªè§†å›¾)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Trace ID: abc123                                           â”‚
â”‚  â”Œâ”€ Span: onClick() [1000ms]                                â”‚
â”‚  â”‚  â”œâ”€ Span: loadProduct() [800ms]                          â”‚
â”‚  â”‚  â”‚  â”œâ”€ Span: validateUser() [50ms]                       â”‚
â”‚  â”‚  â”‚  â”œâ”€ Span: HTTP GET /api/product [700ms] â† RUM Resourceâ”‚
â”‚  â”‚  â”‚  â”‚  parent_span_id è®©æˆ‘ä»¬çŸ¥é“è¿™æ˜¯ loadProduct çš„å­è°ƒç”¨â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ DNS [10ms]                                     â”‚
â”‚  â”‚  â”‚  â”‚  â”œâ”€ Connect [20ms]                                 â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€ Download [640ms]                               â”‚
â”‚  â”‚  â”‚  â””â”€ Span: cacheProduct() [50ms]                       â”‚
â”‚  â”‚  â””â”€ Span: updateUI() [200ms]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Web ç«¯ï¼ˆæ—  parent_span_idï¼‰çš„æ•°æ®å­¤ç«‹**ï¼š

```
Datadog åå°è§†å›¾ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RUM Explorer (ç”¨æˆ·ä¼šè¯è§†å›¾)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Session: xyz-789                                           â”‚
â”‚  â””â”€ View: ProductListView                                   â”‚
â”‚      â””â”€ Resource: GET /api/product/123 [700ms]              â”‚
â”‚          - åªèƒ½çœ‹åˆ°èµ„æºæœ¬èº«çš„æ€§èƒ½                           â”‚
â”‚          - æ— æ³•è·³è½¬åˆ°å®Œæ•´çš„è°ƒç”¨é“¾                           â”‚
â”‚          - ä¸çŸ¥é“è¿™ä¸ªè¯·æ±‚æ˜¯åœ¨ä»€ä¹ˆä¸Šä¸‹æ–‡ä¸­è¢«è°ƒç”¨çš„           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7. æ€»ç»“

**parent_span_id åœ¨ç§»åŠ¨ç«¯æ˜¯å¿…éœ€çš„ï¼Œå› ä¸º**ï¼š

1. âœ… **æ”¯æŒå¤æ‚çš„ Span å±‚æ¬¡ç»“æ„**ï¼šç§»åŠ¨åº”ç”¨çš„ä¸šåŠ¡é€»è¾‘å¤æ‚ï¼Œéœ€è¦å¤šå±‚åµŒå¥—çš„ Span
2. âœ… **RUM å’Œ APM æ·±åº¦é›†æˆ**ï¼šRUM Resource éœ€è¦å…³è”åˆ° APM Span æ¥æ„å»ºå®Œæ•´è§†å›¾
3. âœ… **åˆ†å¸ƒå¼è¿½è¸ªå®Œæ•´æ€§**ï¼šç§»åŠ¨ç«¯åˆ°åç«¯çš„å®Œæ•´è°ƒç”¨é“¾éœ€è¦çˆ¶å­å…³ç³»
4. âœ… **ç«ç„°å›¾å¯è§†åŒ–**ï¼šåªæœ‰æœ‰äº† parent_span_id æ‰èƒ½æ„å»ºè°ƒç”¨æ ˆç«ç„°å›¾
5. âœ… **æ€§èƒ½ç“¶é¢ˆå®šä½**ï¼šå¯ä»¥ç²¾ç¡®å®šä½æ˜¯å“ªä¸€å±‚çš„å“ªä¸ªæ­¥éª¤å¯¼è‡´äº†æ€§èƒ½é—®é¢˜
6. âœ… **æ•°æ®æ‰“é€š**ï¼šåœ¨ RUM ä¸­ç‚¹å‡»èµ„æºå¯ä»¥ç›´æ¥è·³è½¬åˆ° APM Trace æŸ¥çœ‹å®Œæ•´è°ƒç”¨é“¾

**Web ç«¯ä¸éœ€è¦çš„åŸå› **ï¼š

- âŒ æ²¡æœ‰å®Œæ•´çš„ APM Tracing SDK
- âŒ èµ„æºè¿½è¸ªä¸»è¦ç”±æµè§ˆå™¨è‡ªåŠ¨å®Œæˆï¼ˆæ‰å¹³ç»“æ„ï¼‰
- âŒ ä¸éœ€è¦è¿½è¸ªåº”ç”¨å†…çš„å¤æ‚ä¸šåŠ¡é€»è¾‘è°ƒç”¨é“¾
- âŒ æµè§ˆå™¨çš„ Performance API å·²ç»æä¾›äº†è¶³å¤Ÿçš„èµ„æºåŠ è½½è¯¦æƒ…

---

## å…­ã€å¹³å°ç‰¹æ€§æ€»ç»“

### iOS

**ä¼˜åŠ¿**ï¼š

- âœ… å®Œæ•´çš„ span è¿½è¸ªèƒ½åŠ›ï¼ˆparent_span_idï¼‰
- âœ… çµæ´»çš„ trace_id æ ¼å¼æ”¯æŒ
- âœ… è¯¦ç»†çš„ GraphQL é”™è¯¯è¿½è¸ª
- âœ… å¼ºåˆ¶çš„ View ä¸Šä¸‹æ–‡å…³è”

**å®ç°ç‰¹ç‚¹**ï¼š

- ä½¿ç”¨ Swift ä»£ç ç”Ÿæˆ
- ä» rum-events-format ä»“åº“åŠ¨æ€åŒæ­¥
- æ”¯æŒ Objective-C äº’æ“ä½œ

### Android

**ä¼˜åŠ¿**ï¼š

- âœ… å®Œæ•´çš„ span è¿½è¸ªèƒ½åŠ›ï¼ˆparent_span_idï¼‰
- âœ… çµæ´»çš„ trace_id æ ¼å¼æ”¯æŒ
- âœ… è¯¦ç»†çš„ GraphQL é”™è¯¯è¿½è¸ª
- âœ… å¼ºåˆ¶çš„ View ä¸Šä¸‹æ–‡å…³è”

**å®ç°ç‰¹ç‚¹**ï¼š

- ä½¿ç”¨ Kotlin æ•°æ®ç±»
- åœ¨ä»“åº“å†…ç›´æ¥ç»´æŠ¤ schema
- ä¸ iOS å…±äº«ç›¸åŒçš„ç§»åŠ¨ç«¯ schema

### Web

**ä¼˜åŠ¿**ï¼š

- âœ… æ›´çµæ´»çš„ View å…³è”ï¼ˆå¯é€‰ï¼‰
- âœ… æµè§ˆå™¨ç‰¹å®šçš„æ€§èƒ½æŒ‡æ ‡æ”¯æŒ

**é™åˆ¶**ï¼š

- âŒ ä¸æ”¯æŒ parent_span_id
- âŒ trace_id ä»…æ”¯æŒåè¿›åˆ¶æ ¼å¼
- âŒ GraphQL é”™è¯¯è¿½è¸ªè¾ƒç®€å•

**å®ç°ç‰¹ç‚¹**ï¼š

- ä½¿ç”¨ TypeScript ç±»å‹ç³»ç»Ÿ
- ä» rum-events-format ç‹¬ç«‹ä»“åº“ç»´æŠ¤
- æµè§ˆå™¨ç¯å¢ƒä¼˜åŒ–

---

## äº”ã€è®¾è®¡ç†å¿µå·®å¼‚

### ç§»åŠ¨ç«¯ï¼ˆiOS/Androidï¼‰

1. **å¼ºä¸Šä¸‹æ–‡å…³è”**ï¼šæ¯ä¸ªèµ„æºå¿…é¡»å…³è”åˆ° Viewï¼Œåæ˜ ç§»åŠ¨åº”ç”¨çš„é¡µé¢å¯¼èˆªæ¨¡å¼
2. **å®Œæ•´è¿½è¸ª**ï¼šæ”¯æŒå®Œæ•´çš„åˆ†å¸ƒå¼è¿½è¸ªï¼ˆparent_span_id, å¤šæ ¼å¼ trace_idï¼‰
3. **è¯¦ç»†ç›‘æ§**ï¼šGraphQL é”™è¯¯è¯¦ç»†è¿½è¸ªï¼Œé€‚åˆå¤æ‚çš„ç§»åŠ¨ç«¯ API åœºæ™¯

### Web ç«¯

1. **çµæ´»æ€§**ï¼šView å…³è”å¯é€‰ï¼Œé€‚åº”å•é¡µåº”ç”¨çš„åŠ¨æ€ç‰¹æ€§
2. **ç®€åŒ–è¿½è¸ª**ï¼šç®€åŒ–çš„ trace_id æ ¼å¼ï¼Œèšç„¦æµè§ˆå™¨ç¯å¢ƒ
3. **æ€§èƒ½ä¼˜å…ˆ**ï¼šæ›´æ³¨é‡æµè§ˆå™¨ç‰¹æœ‰çš„æ€§èƒ½æŒ‡æ ‡ï¼ˆå¦‚ Navigation Timing APIï¼‰

---

## å…­ã€æ ¸å¿ƒå­—æ®µè¯¦è§£

### 6.1 `rule_psr` - Trace é‡‡æ ·ç‡

**å…¨ç§°**ï¼šRule-based Sampling Rate (åŸºäºè§„åˆ™çš„é‡‡æ ·ç‡)

**æ•°æ®ç±»å‹**ï¼š`number` (0.0 - 1.0)

**ç”¨é€”**ï¼š

1. **APM æµé‡æ§åˆ¶**ï¼šæ­¤å­—æ®µç”¨äºå‘ Datadog APM åç«¯æŠ¥å‘Šå®é™…çš„è¿½è¸ªé‡‡æ ·ç‡ï¼Œå¸®åŠ©åç«¯å‡†ç¡®è®¡ç®—æµé‡å’Œé‡‡æ ·ç»Ÿè®¡
2. **è·¨å¹³å° SDK å¯è§æ€§**ï¼šåœ¨ APM çš„æµé‡æ‘„å…¥æ§åˆ¶é¡µé¢(Traffic Ingestion Control Page)æ˜¾ç¤ºï¼Œè®©æ‚¨äº†è§£ SDK å±‚é¢é…ç½®çš„é‡‡æ ·ç‡
3. **åˆ†å¸ƒå¼è¿½è¸ªå‡†ç¡®æ€§**ï¼šç¡®ä¿åœ¨è·¨æœåŠ¡è°ƒç”¨é“¾ä¸­ï¼Œé‡‡æ ·ç‡ä¿¡æ¯èƒ½å¤Ÿæ­£ç¡®ä¼ é€’å’Œè®¡ç®—

**å·¥ä½œåŸç†**ï¼š

```typescript
// Web SDK ç¤ºä¾‹
{
  "_dd": {
    "span_id": "123456789",
    "trace_id": "987654321",
    "rule_psr": 0.75  // è¡¨ç¤º 75% çš„è¯·æ±‚è¢«é‡‡æ ·è¿½è¸ª
  }
}
```

**å…¸å‹åœºæ™¯**ï¼š

- å½“æ‚¨é…ç½® `tracingSampleRate: 0.5` æ—¶ï¼ŒSDK ä¼šè‡ªåŠ¨å¡«å…… `rule_psr: 0.5`
- APM åç«¯ä½¿ç”¨æ­¤å€¼æ¥ä¼°ç®—å®é™…çš„è¯·æ±‚æ€»é‡ï¼ˆè§‚æµ‹åˆ°çš„è¯·æ±‚æ•° Ã· rule_psr = ä¼°ç®—æ€»é‡ï¼‰
- åœ¨ç¬¬ä¸€æ–¹(first-party)èµ„æºä¸Šï¼Œè¿™ä¸ªå­—æ®µå¿…é¡»å­˜åœ¨ï¼ˆå› ä¸ºè¿™äº›èµ„æºä¼šè¢«è¿½è¸ªï¼‰
- åœ¨ç¬¬ä¸‰æ–¹(third-party)èµ„æºä¸Šï¼Œè¿™ä¸ªå­—æ®µä¸º `null`ï¼ˆå› ä¸ºä¸è¿½è¸ªç¬¬ä¸‰æ–¹èµ„æºï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š

```swift
// iOS - RUMResourceScope.swift
let resourceEvent = RUMResourceEvent(
    dd: .init(
        rulePsr: traceSamplingRate,  // ä»é…ç½®ä¸­è·å–é‡‡æ ·ç‡
        spanId: spanId?.toString(representation: .decimal),
        traceId: traceId?.toString(representation: .hexadecimal)
    ),
    // ... å…¶ä»–å­—æ®µ
)
```

```kotlin
// Android - RumResourceScope.kt
val rulePsr = resourceAttributes.remove(RumAttributes.RULE_PSR) as? Number

ResourceEvent.Dd(
    traceId = traceId,
    spanId = spanId,
    rulePsr = rulePsr  // é‡‡æ ·ç‡
)
```

**é‡è¦æ€§**ï¼š

- âš ï¸ ç¼ºå¤±æˆ–ä¸å‡†ç¡®çš„ `rule_psr` ä¼šå¯¼è‡´ APM æµé‡ç»Ÿè®¡ä¸å‡†ç¡®
- âœ… æ­£ç¡®è®¾ç½®å¯ä»¥åœ¨ Datadog æ§åˆ¶å°è·å¾—å‡†ç¡®çš„æˆæœ¬ä¼°ç®—å’Œæµé‡åˆ†æ

---

#### ğŸ“Š `rule_psr` å½±å“æˆæœ¬ä¼°ç®—çš„è¯¦ç»†è¯´æ˜

**é—®é¢˜åœºæ™¯ï¼šä¸ºä»€ä¹ˆéœ€è¦å‡†ç¡®çš„ rule_psrï¼Ÿ**

Datadog APM æŒ‰ç…§**å®é™…è¯·æ±‚é‡**è®¡è´¹ï¼Œè€Œä¸æ˜¯**é‡‡æ ·åçš„è¯·æ±‚é‡**ã€‚å› æ­¤ï¼Œåç«¯éœ€è¦çŸ¥é“é‡‡æ ·ç‡æ‰èƒ½æ¨ç®—å®é™…æˆæœ¬ã€‚

**æ¡ˆä¾‹ 1ï¼šæ­£ç¡®çš„ rule_psr è®¾ç½®**

```javascript
// æ‚¨çš„åº”ç”¨é…ç½®
const config = {
  traceSampleRate: 0.2  // åªè¿½è¸ª 20% çš„è¯·æ±‚
}

// å®é™…æƒ…å†µ
å®é™…å‘ç”Ÿçš„è¯·æ±‚ï¼š10,000 ä¸ª
è¢«é‡‡æ ·å‘é€çš„è¯·æ±‚ï¼š2,000 ä¸ª (10,000 Ã— 0.2)

// Datadog æ”¶åˆ°çš„æ•°æ®
æ”¶åˆ°çš„ span æ•°é‡ï¼š2,000 ä¸ª
æ¯ä¸ª span æºå¸¦ï¼šrule_psr: 0.2

// Datadog åç«¯æ¨ç®—
ä¼°ç®—å®é™…è¯·æ±‚é‡ = 2,000 Ã· 0.2 = 10,000 ä¸ª âœ… å‡†ç¡®ï¼
ä¼°ç®—æˆæœ¬ = 10,000 Ã— å•ä»·
```

**æ¡ˆä¾‹ 2ï¼šé”™è¯¯çš„ rule_psr è®¾ç½®ï¼ˆæˆ–ç¼ºå¤±ï¼‰**

```javascript
// é…ç½®é”™è¯¯ï¼šå®é™…é‡‡æ ·ç‡ 0.2ï¼Œä½† rule_psr é”™è¯¯å¡«æˆ 0.5
const config = {
  traceSampleRate: 0.2
}
// ä½†ç”±äº SDK bug æˆ–é…ç½®é”™è¯¯
rule_psr: 0.5  // âŒ é”™è¯¯ï¼

// Datadog æ”¶åˆ°çš„æ•°æ®
æ”¶åˆ°çš„ span æ•°é‡ï¼š2,000 ä¸ª
æ¯ä¸ª span æºå¸¦ï¼šrule_psr: 0.5ï¼ˆé”™è¯¯å€¼ï¼‰

// Datadog åç«¯æ¨ç®—
ä¼°ç®—å®é™…è¯·æ±‚é‡ = 2,000 Ã· 0.5 = 4,000 ä¸ª âŒ ä¸¥é‡ä½ä¼°ï¼
ä¼°ç®—æˆæœ¬ = 4,000 Ã— å•ä»·ï¼ˆå®é™…åº”è¯¥æ˜¯ 10,000 Ã— å•ä»·ï¼‰

ç»“æœï¼š
- æˆæœ¬ä¼°ç®—ä½ä¼°äº† 60%ï¼
- APM æ§åˆ¶å°æ˜¾ç¤ºçš„æµé‡ç»Ÿè®¡ä¸å‡†ç¡®
- æœˆåº•è´¦å•å¯èƒ½è¶…å‡ºé¢„æœŸ
```

**æ¡ˆä¾‹ 3ï¼šrule_psr ç¼ºå¤±çš„æƒ…å†µ**

```javascript
// å¦‚æœ rule_psr å­—æ®µå®Œå…¨ç¼ºå¤±
{
  "_dd": {
    "span_id": "123",
    "trace_id": "456",
    // "rule_psr": ç¼ºå¤±ï¼
  }
}

// Datadog åç«¯çš„å¤„ç†
å¯èƒ½å‡è®¾ rule_psr = 1.0ï¼ˆ100% é‡‡æ ·ï¼‰
ä¼°ç®—å®é™…è¯·æ±‚é‡ = 2,000 Ã· 1.0 = 2,000 ä¸ª âŒ ä¸¥é‡ä½ä¼°ï¼

å®é™…åº”è¯¥æ˜¯ï¼š2,000 Ã· 0.2 = 10,000 ä¸ª
è¯¯å·®ï¼šä½ä¼°äº† 80%ï¼
```

---

**å®é™…å½±å“**ï¼š

| æƒ…å†µ      | å®é™…è¯·æ±‚ | é‡‡æ ·ç‡ | å‘é€é‡ | rule_psr | åç«¯æ¨ç®— | è¯¯å·® |
| --------- | -------- | ------ | ------ | -------- | -------- | ---- |
| âœ… æ­£ç¡®   | 10,000   | 0.2    | 2,000  | 0.2      | 10,000   | 0%   |
| âŒ å¡«é”™å€¼ | 10,000   | 0.2    | 2,000  | 0.5      | 4,000    | -60% |
| âŒ ç¼ºå¤±   | 10,000   | 0.2    | 2,000  | å‡è®¾ 1.0 | 2,000    | -80% |

---

**ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦ï¼Ÿ**

1. **æˆæœ¬é¢„æµ‹ä¸å‡†**ï¼š

   - APM æ§åˆ¶å°æ˜¾ç¤ºï¼š"æ‚¨æœ¬æœˆä½¿ç”¨äº† 400 ä¸‡ä¸ª span"
   - å®é™…æƒ…å†µï¼š"æ‚¨æœ¬æœˆå®é™…æœ‰ 2000 ä¸‡ä¸ªè¯·æ±‚"
   - ç»“æœï¼šæœˆåº•æ”¶åˆ°è´¦å•æ—¶å¤§åƒä¸€æƒŠ ğŸ’¸

2. **æµé‡åˆ†æå¤±çœŸ**ï¼š

   - æ— æ³•å‡†ç¡®è¯„ä¼°ç³»ç»Ÿè´Ÿè½½
   - å®¹é‡è§„åˆ’æ•°æ®ä¸å¯é 
   - æ€§èƒ½ä¼˜åŒ–çš„ ROI è®¡ç®—é”™è¯¯

3. **å¤šå›¢é˜Ÿç¯å¢ƒæ··ä¹±**ï¼š

   ```
   å›¢é˜Ÿ Aï¼šrule_psr = 0.1ï¼ˆæ­£ç¡®ï¼‰â†’ å‡†ç¡®çš„æˆæœ¬åˆ†æ‘Š
   å›¢é˜Ÿ Bï¼šrule_psr ç¼ºå¤± â†’ æˆæœ¬è¢«ä¸¥é‡ä½ä¼°
   å›¢é˜Ÿ Cï¼šrule_psr = 0.8ï¼ˆé”™è¯¯ï¼‰â†’ æˆæœ¬è¢«é«˜ä¼°

   ç»“æœï¼šå„å›¢é˜Ÿæˆæœ¬åˆ†æ‘Šä¸å…¬å¹³ï¼Œæ— æ³•å‡†ç¡®è¯„ä¼°å„æœåŠ¡æˆæœ¬
   ```

---

**æœ€ä½³å®è·µ**ï¼š

1. **éªŒè¯ rule_psr æ­£ç¡®æ€§**ï¼š

   ```javascript
   // åœ¨ SDK åˆå§‹åŒ–æ—¶éªŒè¯
   console.assert(
     sentRulePsr === configuredSampleRate,
     `rule_psr mismatch: ${sentRulePsr} !== ${configuredSampleRate}`
   );
   ```

2. **å®šæœŸæ£€æŸ¥ APM æ§åˆ¶å°**ï¼š

   - æŸ¥çœ‹ "Traffic Ingestion Control" é¡µé¢
   - ç¡®è®¤æ˜¾ç¤ºçš„é‡‡æ ·ç‡ä¸é…ç½®ä¸€è‡´
   - æ¯”å¯¹æ¨ç®—æµé‡ä¸å®é™…ä¸šåŠ¡æŒ‡æ ‡

3. **è·¨å¹³å°ä¸€è‡´æ€§**ï¼š

   ```yaml
   iOS: rule_psr = 0.3
   Android: rule_psr = 0.3
   Web: rule_psr = 0.3
   # ç¡®ä¿åŒä¸€æœåŠ¡åœ¨ä¸åŒå¹³å°çš„é‡‡æ ·ç‡ä¸€è‡´
   # å¦åˆ™æˆæœ¬åˆ†æä¼šå¾ˆæ··ä¹±
   ```

4. **ç›‘æ§é‡‡æ ·ç‡å˜åŒ–**ï¼š
   - å¦‚æœåŠ¨æ€è°ƒæ•´é‡‡æ ·ç‡ï¼Œç¡®ä¿ rule_psr åŒæ­¥æ›´æ–°
   - è®°å½•é‡‡æ ·ç‡å˜æ›´å†å²ï¼Œä¾¿äºè¿½æº¯æˆæœ¬æ³¢åŠ¨åŸå› 

---

### 6.2 `discarded` - èµ„æºä¸¢å¼ƒæ ‡è®°

**æ•°æ®ç±»å‹**ï¼š`boolean`

**ç”¨é€”**ï¼š

1. **èµ„æºè¿½è¸ªæ§åˆ¶**ï¼šæ ‡è®°èµ„æºäº‹ä»¶æ˜¯å¦åº”è¯¥è¢«ç´¢å¼•ï¼Œè¿˜æ˜¯ä»…ç”¨äºè¿½è¸ª(tracing)
2. **æˆæœ¬ä¼˜åŒ–**ï¼šå½“ `trackResources: false` æ—¶ï¼Œä»ç„¶ä¿ç•™è¿½è¸ªä¿¡æ¯ä½†ä¸ç´¢å¼•èµ„æºè¯¦æƒ…
3. **äº‹ä»¶è®¡æ•°å‡†ç¡®æ€§**ï¼šåœ¨ç»Ÿè®¡ View ä¸­çš„èµ„æºæ•°é‡æ—¶ï¼Œè¢«ä¸¢å¼ƒçš„èµ„æºä¸åº”è®¡å…¥

**å·¥ä½œåŸç†**ï¼š

```typescript
// Web SDK ç¤ºä¾‹
const resourceEvent = {
  resource: {
    id: "uuid-here",
    type: "fetch",
    url: "https://api.example.com/data",
  },
  _dd: {
    discarded: !configuration.trackResources, // å…³é”®é€»è¾‘
    trace_id: "123456",
    span_id: "789012",
  },
};
```

**ä¸¤ç§åœºæ™¯**ï¼š

#### åœºæ™¯ 1ï¼šæ­£å¸¸è¿½è¸ªå’Œèµ„æºç›‘æ§ï¼ˆdiscarded: falseï¼‰

```javascript
// é…ç½®
const DD_RUM = {
  trackResources: true,        // å¯ç”¨èµ„æºç›‘æ§
  traceSampleRate: 0.5         // 50% è¿½è¸ªé‡‡æ ·
}

// ç»“æœï¼šèµ„æºä¼šè¢«å®Œæ•´è®°å½•å’Œç´¢å¼•
{
  "_dd": {
    "discarded": false,         // ä¸ä¸¢å¼ƒï¼Œå®Œæ•´ç´¢å¼•
    "trace_id": "123",
    "span_id": "456",
    "rule_psr": 0.5
  }
}
```

#### åœºæ™¯ 2ï¼šä»…è¿½è¸ªä¸ç›‘æ§èµ„æºï¼ˆdiscarded: trueï¼‰

```javascript
// é…ç½®
const DD_RUM = {
  trackResources: false,       // ç¦ç”¨èµ„æºç›‘æ§
  traceSampleRate: 0.5         // ä»å¯ç”¨è¿½è¸ª
}

// ç»“æœï¼šä¿ç•™è¿½è¸ªä¿¡æ¯ï¼Œä½†èµ„æºè¯¦æƒ…è¢«ä¸¢å¼ƒ
{
  "_dd": {
    "discarded": true,          // ä¸¢å¼ƒèµ„æºè¯¦æƒ…
    "trace_id": "123",          // ä½†ä¿ç•™è¿½è¸ªä¿¡æ¯
    "span_id": "456",
    "rule_psr": 0.5
  }
}
```

**äº‹ä»¶è®¡æ•°é€»è¾‘**ï¼š

```typescript
// Web SDK - trackEventCounts.ts
case RumEventType.RESOURCE:
  if (!event._dd?.discarded) {
    eventCounts.resourceCount += 1  // åªç»Ÿè®¡æœªä¸¢å¼ƒçš„èµ„æº
    callback()
  }
  break
```

**ä½¿ç”¨åœºæ™¯**ï¼š

1. **æˆæœ¬æ§åˆ¶**ï¼š

   - å½“æ‚¨æƒ³è¦ APM è¿½è¸ªä½†ä¸æƒ³ä¸ºæ¯ä¸ªèµ„æºä»˜è´¹æ—¶
   - è®¾ç½® `trackResources: false`ï¼Œèµ„æºä¼šæ ‡è®°ä¸º `discarded: true`
   - APM span ä»ç„¶åˆ›å»ºï¼Œä½† RUM èµ„æºäº‹ä»¶ä¸è®¡è´¹

2. **ç²¾ç¡®ç»Ÿè®¡**ï¼š

   - View çš„ `resource.count` åªç»Ÿè®¡ `discarded: false` çš„èµ„æº
   - é¿å…é‡å¤è®¡æ•°æˆ–ç»Ÿè®¡åå·®

3. **é€‰æ‹©æ€§ç›‘æ§**ï¼š
   - æŸäº›å†…éƒ¨/è°ƒè¯•è¯·æ±‚å¯ä»¥æ ‡è®°ä¸º `discarded: true`
   - ä¿ç•™è¿½è¸ªé“¾è·¯ä½†ä¸å½±å“ RUM ç»Ÿè®¡

**å¹³å°å·®å¼‚**ï¼š

- **Web**ï¼šæ˜ç¡®ä½¿ç”¨ `discarded` å­—æ®µæ§åˆ¶èµ„æºæ˜¯å¦è®¡å…¥ç»Ÿè®¡
- **iOS/Android**ï¼šä¹Ÿæ”¯æŒè¯¥å­—æ®µï¼Œä½†é€šå¸¸åœ¨ SDK å±‚é¢å°±å†³å®šæ˜¯å¦å‘é€äº‹ä»¶ï¼Œè€Œä¸æ˜¯æ ‡è®°åå†ä¸¢å¼ƒ

**é‡è¦æ€§**ï¼š

- âœ… æ­£ç¡®è®¾ç½®å¯ä»¥ä¼˜åŒ–æˆæœ¬ï¼ˆä»…è¿½è¸ªä¸ç´¢å¼•ï¼‰
- âœ… ç¡®ä¿ç»Ÿè®¡å‡†ç¡®æ€§ï¼ˆView èµ„æºè®¡æ•°ï¼‰
- âš ï¸ é”™è¯¯è®¾ç½®å¯èƒ½å¯¼è‡´ APM é“¾è·¯ä¸å®Œæ•´æˆ–èµ„æºç»Ÿè®¡ä¸å‡†

---

## ä¸ƒã€å‡çº§å»ºè®®

### å¦‚æœæ‚¨æ­£åœ¨å¼€å‘è·¨å¹³å°åº”ç”¨ï¼š

1. **æ•°æ®æ¨¡å‹ç»Ÿä¸€**ï¼š

   - åœ¨ä»£ç ä¸­ä½¿ç”¨ç§»åŠ¨ç«¯çš„å®Œæ•´æ¨¡å‹ï¼ˆåŒ…å« parent_span_idï¼‰
   - Web ç«¯å¯é€‰æ‹©æ€§å¿½ç•¥ä¸æ”¯æŒçš„å­—æ®µ

2. **GraphQL ç›‘æ§**ï¼š

   - ç§»åŠ¨ç«¯åº”å……åˆ†åˆ©ç”¨è¯¦ç»†çš„ GraphQL é”™è¯¯è¿½è¸ª
   - Web ç«¯éœ€è¦åº”ç”¨å±‚è¡¥å……é”™è¯¯ä¿¡æ¯

3. **View å…³è”ç­–ç•¥**ï¼š

   - ç§»åŠ¨ç«¯ï¼šä¸¥æ ¼å…³è” View
   - Web ç«¯ï¼šæ ¹æ®å•é¡µåº”ç”¨è·¯ç”±è‡ªåŠ¨å…³è”

4. **é‡‡æ ·ç‡é…ç½®**ï¼š

   - ç¡®ä¿ `rule_psr` åœ¨æ‰€æœ‰å¹³å°ä¸Šæ­£ç¡®é…ç½®
   - ç¬¬ä¸€æ–¹èµ„æºå¿…é¡»åŒ…å«é‡‡æ ·ç‡ä¿¡æ¯
   - å®šæœŸæ£€æŸ¥ APM æ§åˆ¶å°çš„æµé‡ç»Ÿè®¡æ˜¯å¦å‡†ç¡®

5. **æˆæœ¬ä¼˜åŒ–ç­–ç•¥**ï¼š
   - ä½¿ç”¨ `discarded` æ ‡è®°æ¥å¹³è¡¡è¿½è¸ªå’Œç›‘æ§æˆæœ¬
   - è€ƒè™‘å¯¹å†…éƒ¨/å¥åº·æ£€æŸ¥è¯·æ±‚è®¾ç½® `discarded: true`
   - ä¿æŒ APM è¿½è¸ªé“¾è·¯å®Œæ•´æ€§çš„åŒæ—¶ä¼˜åŒ– RUM èµ„æºäº‹ä»¶æˆæœ¬

---

## å…«ã€å…¶ä»–é‡è¦å­—æ®µè¯´æ˜

### 8.1 `ddtags` - æ ‡ç­¾ç³»ç»Ÿ

**æ•°æ®ç±»å‹**ï¼š`string`

**æ ¼å¼**ï¼š`"key1:value1,key2:value2,key3:value3"`

**ç”¨é€”**ï¼š

1. **æ•°æ®åˆ†ç±»å’Œç­›é€‰**ï¼šåœ¨ Datadog æ§åˆ¶å°é€šè¿‡æ ‡ç­¾å¿«é€Ÿç­›é€‰å’Œåˆ†ç»„äº‹ä»¶
2. **ç¯å¢ƒåŒºåˆ†**ï¼šæ ‡è®°äº‹ä»¶æ¥è‡ªå“ªä¸ªç¯å¢ƒï¼ˆdevã€stagingã€productionï¼‰
3. **ç‰ˆæœ¬è¿½è¸ª**ï¼šè¿½è¸ªä¸åŒç‰ˆæœ¬çš„è¡¨ç°
4. **å›¢é˜Ÿåˆ†ç»„**ï¼šæŒ‰å›¢é˜Ÿã€æœåŠ¡ã€åŒºåŸŸç­‰ç»´åº¦ç»„ç»‡æ•°æ®

**å…¸å‹å†…å®¹**ï¼š

```javascript
// ç¤ºä¾‹å€¼
"ddtags": "env:production,version:2.3.1,variant:release,team:mobile,region:us-east"
```

**å¦‚ä½•ä½¿ç”¨**ï¼š

```kotlin
// Android - SDK è‡ªåŠ¨æ·»åŠ 
Datadog.initialize(
    context,
    Configuration.Builder(
        clientToken = "YOUR_CLIENT_TOKEN",
        env = "production",  // è‡ªåŠ¨æ·»åŠ åˆ° ddtags: "env:production"
        variant = "release"  // è‡ªåŠ¨æ·»åŠ åˆ° ddtags: "variant:release"
    )
    .setVersion("2.3.1")    // è‡ªåŠ¨æ·»åŠ åˆ° ddtags: "version:2.3.1"
    .build()
)
```

```swift
// iOS - SDK è‡ªåŠ¨æ·»åŠ 
Datadog.initialize(
    with: Datadog.Configuration(
        clientToken: "YOUR_CLIENT_TOKEN",
        env: "production",  // è‡ªåŠ¨æ·»åŠ åˆ° ddtags
        service: "mobile-app"
    ),
    trackingConsent: .granted
)
```

**åœ¨ Datadog æ§åˆ¶å°çš„åº”ç”¨**ï¼š

- ç­›é€‰å™¨ï¼š`env:production AND version:2.3.1`
- åˆ†ç»„ï¼šæŒ‰ `team` æ ‡ç­¾åˆ†ç»„æŸ¥çœ‹å„å›¢é˜Ÿçš„é”™è¯¯ç‡
- å¯¹æ¯”ï¼šæ¯”è¾ƒä¸åŒ `variant`ï¼ˆdebug vs releaseï¼‰çš„æ€§èƒ½

**æœ€ä½³å®è·µ**ï¼š

1. **ä¿æŒä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰€æœ‰å¹³å°ä½¿ç”¨ç›¸åŒçš„æ ‡ç­¾å‘½åè§„èŒƒ
2. **é¿å…è¿‡å¤šæ ‡ç­¾**ï¼šå¤ªå¤šæ ‡ç­¾ä¼šå¢åŠ æ•°æ®å¤§å°ï¼Œå»ºè®®ä¸è¶…è¿‡ 10 ä¸ª
3. **ä½¿ç”¨æœ‰æ„ä¹‰çš„å€¼**ï¼š`env:prod` æ¯” `env:1` æ›´æ˜“è¯»

---

### 8.2 `container` - çˆ¶è§†å›¾å®¹å™¨

**æ•°æ®ç±»å‹**ï¼š`object`

**ç”¨é€”**ï¼šç”¨äºåµŒå¥—è§†å›¾åœºæ™¯ï¼Œç‰¹åˆ«æ˜¯ **WebView** æˆ–è·¨å¹³å°æ··åˆåº”ç”¨

**ç»“æ„**ï¼š

```json
{
  "container": {
    "view": {
      "id": "abc-123-def-456" // çˆ¶è§†å›¾çš„ UUID
    },
    "source": "android" // çˆ¶è§†å›¾æ¥æºå¹³å°
  }
}
```

**å…¸å‹ä½¿ç”¨åœºæ™¯**ï¼š

#### åœºæ™¯ 1ï¼šç§»åŠ¨åº”ç”¨å†…åµŒ WebView

```
ç§»åŠ¨åº”ç”¨ï¼ˆAndroidï¼‰
  â””â”€â”€ WebViewï¼ˆBrowser SDKï¼‰
```

å½“ WebView ä¸­çš„ Browser SDK å‘é€ RUM äº‹ä»¶æ—¶ï¼š

```json
{
  "type": "resource",
  "source": "browser", // å½“å‰äº‹ä»¶æ¥è‡ª browser
  "view": {
    "id": "webview-view-123" // WebView å†…çš„é¡µé¢ ID
  },
  "container": {
    "view": {
      "id": "native-view-456" // åŒ…å« WebView çš„åŸç”Ÿé¡µé¢ ID
    },
    "source": "android" // çˆ¶å®¹å™¨æ˜¯ Android
  }
}
```

**ä¸ºä»€ä¹ˆéœ€è¦ containerï¼Ÿ**

1. **å®Œæ•´çš„ç”¨æˆ·æ—…ç¨‹è¿½è¸ª**ï¼š

   ```
   ç”¨æˆ·è·¯å¾„ï¼š
   Native é¦–é¡µ â†’ Native å•†å“åˆ—è¡¨ â†’ WebView å•†å“è¯¦æƒ… â†’ Native è´­ç‰©è½¦

   é€šè¿‡ container å¯ä»¥ï¼š
   - è¿½è¸ªæ•´ä¸ªè·¨å¹³å°çš„ç”¨æˆ·æµç¨‹
   - åˆ†æ WebView æ€§èƒ½å¯¹æ•´ä½“ä½“éªŒçš„å½±å“
   - è¯†åˆ«æ˜¯å“ªä¸ªåŸç”Ÿé¡µé¢æ‰“å¼€äº† WebView
   ```

2. **æ€§èƒ½å½’å› åˆ†æ**ï¼š

   - WebView ä¸­çš„æ…¢èµ„æºæ˜¯å¦å½±å“äº†åŸç”Ÿé¡µé¢ä½“éªŒï¼Ÿ
   - å“ªä¸ªåŸç”Ÿé¡µé¢æœ€å¸¸ä½¿ç”¨ WebViewï¼Ÿ
   - WebView é”™è¯¯ç‡æŒ‰åŸç”Ÿé¡µé¢åˆ†ç»„ç»Ÿè®¡

3. **æ··åˆæ¶æ„å¯è§æ€§**ï¼š

   ```
   React Native App
     â””â”€â”€ Native Module
       â””â”€â”€ WebView

   å¯ä»¥è¿½è¸ªä¸‰å±‚åµŒå¥—å…³ç³»
   ```

**ä½•æ—¶æœ‰ container å­—æ®µï¼Ÿ**

| åœºæ™¯                 | source          | container                  |
| -------------------- | --------------- | -------------------------- |
| çº¯åŸç”Ÿåº”ç”¨           | `android`/`ios` | âŒ æ—                       |
| çº¯ Web åº”ç”¨          | `browser`       | âŒ æ—                       |
| WebViewï¼ˆç§»åŠ¨å†…ï¼‰    | `browser`       | âœ… æœ‰ï¼ˆæŒ‡å‘åŸç”Ÿï¼‰          |
| Flutter WebView      | `browser`       | âœ… æœ‰ï¼ˆæŒ‡å‘ flutterï¼‰      |
| React Native WebView | `browser`       | âœ… æœ‰ï¼ˆæŒ‡å‘ react-nativeï¼‰ |

---

### 8.3 `browser_sdk_version` - è·¨å¹³å° SDK ç‰ˆæœ¬

**é—®é¢˜**ï¼šä¸ºä»€ä¹ˆ Android è¯·æ±‚ä¸­ä¼šæœ‰ `browser_sdk_version` å­—æ®µï¼Ÿ

**ç­”æ¡ˆ**ï¼šè¿™ä¸æ˜¯ bugï¼è¿™æ˜¯ **æ··åˆåº”ç”¨æ¶æ„** çš„æ ‡å¿—ã€‚

**ä¸‰ç§å¯èƒ½çš„æƒ…å†µ**ï¼š

#### æƒ…å†µ 1ï¼šWebView é›†æˆ Browser SDK

```kotlin
// Android åŸç”Ÿåº”ç”¨ä¸­é›†æˆ WebView
class MainActivity : AppCompatActivity() {
    private lateinit var webView: WebView

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        webView = findViewById(R.id.webview)

        // WebView åŠ è½½åŒ…å« Datadog Browser SDK çš„ç½‘é¡µ
        webView.loadUrl("https://example.com/hybrid-page")
        // è¯¥é¡µé¢ä½¿ç”¨äº† Datadog Browser SDK 6.23.0
    }
}
```

æ­¤æ—¶å‘é€çš„ RUM äº‹ä»¶ï¼š

```json
{
  "source": "browser", // äº‹ä»¶ç”± WebView å†…çš„ Browser SDK å‘é€
  "_dd": {
    "browser_sdk_version": "6.23.0", // Browser SDK ç‰ˆæœ¬
    "sdk_name": "rum"
  },
  "container": {
    "source": "android", // ä½†çˆ¶å®¹å™¨æ˜¯ Android åŸç”Ÿ
    "view": {
      "id": "native-view-id"
    }
  }
}
```

#### æƒ…å†µ 2ï¼šReact Native / Flutter æ··åˆ

```typescript
// React Native åº”ç”¨ä½¿ç”¨ WebView ç»„ä»¶
import { WebView } from "react-native-webview";

function HybridScreen() {
  return (
    <WebView
      source={{ uri: "https://example.com/web-content" }}
      // è¯¥ç½‘é¡µä½¿ç”¨ Datadog Browser SDK
    />
  );
}
```

#### æƒ…å†µ 3ï¼šDatadog è‡ªåŠ¨æ¡¥æ¥

æŸäº› Datadog SDK ä¼šè‡ªåŠ¨åœ¨ WebView å’ŒåŸç”Ÿä¹‹é—´å»ºç«‹æ¡¥æ¥ï¼š

```kotlin
// Android SDK å¯èƒ½é…ç½®äº† WebView è¿½è¸ª
val rumConfiguration = RumConfiguration.Builder(applicationId)
    .trackWebView(true)  // å¯ç”¨ WebView è¿½è¸ª
    .build()
```

**å¦‚ä½•åˆ¤æ–­æ˜¯å¦æ˜¯æ··åˆåº”ç”¨ï¼Ÿ**

```json
// æ£€æŸ¥å­—æ®µç»„åˆ
{
  "source": "browser", // â† å½“å‰æ˜¯ browser
  "_dd": {
    "browser_sdk_version": "6.23.0"
  },
  "container": {
    "source": "android" // â† ä½†çˆ¶å®¹å™¨æ˜¯ android
  }
}

// è¿™æ„å‘³ç€ï¼š
// - Android åº”ç”¨å†…åµŒäº† WebView
// - WebView åŠ è½½çš„é¡µé¢ä½¿ç”¨äº† Browser SDK 6.23.0
// - ä¸¤ä¸ª SDK é€šè¿‡æŸç§æ–¹å¼å…³è”äº†è¿½è¸ªæ•°æ®
```

**ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦ï¼Ÿ**

1. **å‡†ç¡®çš„æ¶æ„ç†è§£**ï¼š

   - ä¸æ˜¯çº¯ Android åº”ç”¨
   - æ˜¯æ··åˆåº”ç”¨ï¼ˆNative + Webï¼‰
   - éœ€è¦åŒæ—¶ä¼˜åŒ–ä¸¤ç«¯æ€§èƒ½

2. **ç‰ˆæœ¬ç®¡ç†**ï¼š

   ```json
   {
     "source": "android",
     "_dd": {
       "sdk_version": "2.3.0"  // Android SDK ç‰ˆæœ¬
     }
   }

   VS

   {
     "source": "browser",
     "_dd": {
       "browser_sdk_version": "6.23.0"  // Browser SDK ç‰ˆæœ¬
     },
     "container": {
       "source": "android"
     }
   }
   ```

   å¯ä»¥è¿½è¸ªä¸¤ç«¯ SDK ç‰ˆæœ¬ç»„åˆçš„å…¼å®¹æ€§é—®é¢˜

3. **è°ƒè¯•æ··åˆåº”ç”¨é—®é¢˜**ï¼š
   - æ€§èƒ½é—®é¢˜æ˜¯æ¥è‡ªåŸç”Ÿè¿˜æ˜¯ WebViewï¼Ÿ
   - å“ªä¸ª SDK ç‰ˆæœ¬ç»„åˆæœ‰å…¼å®¹æ€§é—®é¢˜ï¼Ÿ
   - åŸç”Ÿå’Œ Web ç«¯çš„è¿½è¸ªæ•°æ®æ˜¯å¦æ­£ç¡®å…³è”ï¼Ÿ

---

**æ€»ç»“å¯¹æ¯”è¡¨**ï¼š

| å­—æ®µ                  | ç±»å‹   | ç”¨é€”                         | ç¤ºä¾‹å€¼                                         |
| --------------------- | ------ | ---------------------------- | ---------------------------------------------- |
| `ddtags`              | string | æ•°æ®åˆ†ç±»å’Œç­›é€‰               | `"env:prod,version:2.3.1"`                     |
| `container`           | object | åµŒå¥—è§†å›¾è¿½è¸ªï¼ˆWebViewï¼‰      | `{"view": {"id": "..."}, "source": "android"}` |
| `browser_sdk_version` | string | Browser SDK ç‰ˆæœ¬ï¼ˆæ··åˆåº”ç”¨ï¼‰ | `"6.23.0"`                                     |

---

## ä¹ã€å‚è€ƒé“¾æ¥

- iOS Schema: `/tools/rum-models-generator/rum-events-format/schemas/rum/resource-schema.json`
- Android Schema: `/features/dd-sdk-android-rum/src/main/json/rum/resource-schema.json`
- Web Schema: `https://github.com/DataDog/rum-events-format`

---

**æ–‡æ¡£ç”Ÿæˆä¿¡æ¯**ï¼š

- ç”Ÿæˆæ—¥æœŸï¼š2025-10-30
- iOS SDK ç‰ˆæœ¬ï¼šåŸºäº master åˆ†æ”¯
- Schema ç‰ˆæœ¬ï¼šrum-events-format master åˆ†æ”¯
